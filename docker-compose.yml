version: '3.8'

services:
  orchestrator:
    # Build the orchestrator service from the context of the orchestrator folder
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    # Map port 8000 on the container to port 8000 on your host machine
    ports:
      - "8000:8000"
    # Read environment variables from the .env file
    env_file:
      - ./.env
    # Mount local folders into the container to share data/code
    volumes:
      # Mount the main app code (main.py is now directly at /app/main.py)
      - ./orchestrator/app:/app
      # Mount the job scripts for spark-submit
      - ./jobs:/jobs
      # Mount the data folder for local input files
      - ./data:/data
      # Mount the outputs folder for results
      - ./outputs:/outputs
      # The logs folder for job logs
      - ./logs:/logs
    # Start the FastAPI server using Uvicorn
    # FIX: Uses 'main:app' to correctly match the volume mount path /app/main.py
    # Also fixes the port to 8000.
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload